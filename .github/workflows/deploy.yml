name: Deploy MinIO Console to VPS

on:
  push:
    branches:
      - dev
    paths:
      - 'web-app/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð· GitHub UI

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "ðŸ”„ Starting deployment..."
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ
            sudo /usr/local/bin/deploy-minio-console.sh
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
            if [ $? -eq 0 ]; then
              echo "âœ… Deployment completed successfully!"
              echo "ðŸŒ Console URL: https://console.t36a.ru"
            else
              echo "âŒ Deployment failed!"
              exit 1
            fi

      - name: ðŸ¥ Health Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "ðŸ¥ Running health checks..."
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½
            if docker ps | grep -q minio-console-custom; then
              echo "âœ… Container is running"
            else
              echo "âŒ Container is not running"
              exit 1
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ HTTP Ð¾Ñ‚Ð²ÐµÑ‚
            if curl -f http://127.0.0.1:8081 > /dev/null 2>&1; then
              echo "âœ… HTTP endpoint is responding"
            else
              echo "âŒ HTTP endpoint is not responding"
              exit 1
            fi
            
            # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            echo ""
            echo "ðŸ“Š Container status:"
            docker ps | grep minio-console-custom
            echo ""
            echo "ðŸ“ Recent logs:"
            docker logs --tail 5 minio-console-custom

      - name: ðŸ“¢ Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "## âœ… Deployment Successful! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "MinIO Console has been deployed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Console URL:** https://console.t36a.ru" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **API URL:** https://api.t36a.ru" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Landing:** https://t36a.ru" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
